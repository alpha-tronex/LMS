<section class="masthead bg-primary text-white text-center">
  <div class="container">
    <app-admin-breadcrumb></app-admin-breadcrumb>
    
    <h2 class="mb-4">Assessment Data Management</h2>
    
    <div class="card text-dark">
      <div class="card-body">
        <div *ngIf="message" class="alert" [ngClass]="messageType === 'success' ? 'alert-success' : 'alert-danger'">
          {{ message }}
        </div>

        <div class="row text-start">
          <!-- Section 1: Edit Assessment File -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                  <i class="fas fa-edit"></i> Edit Assessment File
                </h5>
              </div>
              <div class="card-body">
                <p class="text-muted">Select and edit an existing assessment file</p>
                
                <div class="mb-3">
                  <label for="editQuizSelect" class="form-label"><strong>Select Assessment:</strong></label>
                  <select 
                    id="editQuizSelect" 
                    class="form-select" 
                    [(ngModel)]="selectedEditAssessmentFileId"
                    [disabled]="assessmentFiles.length === 0">
                    <option value="">-- Choose an assessment --</option>
                    <option *ngFor="let quiz of assessmentFiles" [value]="quiz.id">
                      {{ quiz.title }} (ID: {{ quiz.id }})
                    </option>
                  </select>
                  <small class="text-muted" *ngIf="assessmentFiles.length === 0">No assessment files found</small>
                  <small class="text-muted" *ngIf="assessmentFiles.length > 0">{{ assessmentFiles.length }} assessment file(s) available</small>
                </div>

                <button 
                  class="btn btn-secondary w-100" 
                  [disabled]="!selectedEditAssessmentFileId"
                  [routerLink]="['/admin/edit-assessment', selectedEditAssessmentFileId]">
                  <i class="fas fa-edit"></i> Edit Selected Assessment
                </button>
              </div>
            </div>
          </div>

          <!-- Section 2: Delete User Assessment Data -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                  <i class="fas fa-user-minus"></i> Delete User Assessment Data
                </h5>
              </div>
              <div class="card-body">
                <p class="text-muted">Remove all assessment history for a specific user</p>
                
                <div class="mb-3">
                  <label for="userSelect" class="form-label"><strong>Select User:</strong></label>
                  <select 
                    id="userSelect" 
                    class="form-select" 
                    [(ngModel)]="selectedUserId"
                    [disabled]="users.length === 0">
                    <option value="">-- Choose a user --</option>
                    <option *ngFor="let user of users" [value]="user.id">
                      {{ getUserDisplayName(user) }}
                      <span *ngIf="user.assessments && user.assessments.length > 0">
                        ({{ user.assessments.length }} assessment{{ user.assessments.length !== 1 ? 's' : '' }})
                      </span>
                    </option>
                  </select>
                </div>

                <button 
                  class="btn btn-warning w-100" 
                  [disabled]="!selectedUserId || loading"
                  (click)="deleteUserAssessmentData()">
                  <i class="fas fa-trash"></i> Delete User's Assessment Data
                </button>
              </div>
            </div>
          </div>

          <!-- Section 2: Delete all assessment data from all users -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                  <i class="fas fa-users-slash"></i> Delete All User Assessment Data
                </h5>
              </div>
              <div class="card-body">
                <p class="text-muted">Remove all assessment history from all users in the database</p>
                
                <div class="alert alert-danger mb-3">
                  <i class="fas fa-exclamation-triangle"></i>
                  <strong>Warning:</strong> This will delete ALL assessment data from ALL users. This action cannot be undone!
                </div>

                <button 
                  class="btn btn-danger w-100" 
                  [disabled]="loading"
                  (click)="deleteAllUsersAssessmentData()">
                  <i class="fas fa-bomb"></i> Delete All Users' Assessment Data
                </button>
              </div>
            </div>
          </div>

          <!-- Section 3: Delete specific assessment from specific user -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                  <i class="fas fa-user-times"></i> Delete Specific Assessment from User
                </h5>
              </div>
              <div class="card-body">
                <p class="text-muted">Remove a specific assessment entry from a user's history</p>
                
                <div class="mb-3">
                  <label for="userSelectSpecific" class="form-label"><strong>Select User:</strong></label>
                  <select 
                    id="userSelectSpecific" 
                    class="form-select" 
                    [(ngModel)]="selectedUserIdForSpecificAssessment"
                    (change)="onUserSelectForSpecificAssessment()"
                    [disabled]="users.length === 0">
                    <option value="">-- Choose a user --</option>
                    <option *ngFor="let user of users" [value]="user.id">
                      {{ getUserDisplayName(user) }}
                      <span *ngIf="user.assessments && user.assessments.length > 0">
                        ({{ user.assessments.length }} assessment{{ user.assessments.length !== 1 ? 's' : '' }})
                      </span>
                    </option>
                  </select>
                </div>

                <div class="mb-3" *ngIf="selectedUserIdForSpecificAssessment">
                  <label for="userQuizSelect" class="form-label"><strong>Select Assessment:</strong></label>
                  <select 
                    id="userQuizSelect" 
                    class="form-select" 
                    [(ngModel)]="selectedUserAssessmentId"
                    [disabled]="userAssessments.length === 0">
                    <option value="">-- Choose an assessment --</option>
                    <option *ngFor="let quiz of userAssessments" [value]="quiz._id">
                      {{ quiz.title }} - {{ formatAssessmentDate(quiz.completedAt) }} (Score: {{ quiz.score }}/{{ quiz.totalQuestions }})
                    </option>
                  </select>
                  <small class="text-muted" *ngIf="userAssessments.length === 0">No assessments found for this user</small>
                  <small class="text-muted" *ngIf="userAssessments.length > 0">{{ userAssessments.length }} assessment entry(ies) found</small>
                </div>

                <button 
                  class="btn btn-warning w-100" 
                  [disabled]="!selectedUserIdForSpecificAssessment || !selectedUserAssessmentId || loading"
                  (click)="deleteSpecificUserAssessment()">
                  <i class="fas fa-trash-alt"></i> Delete Selected Assessment Entry
                </button>
              </div>
            </div>
          </div>

          <!-- Section 4: Delete a specific assessment file -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                  <i class="fas fa-file-excel"></i> Delete Assessment File
                </h5>
              </div>
              <div class="card-body">
                <p class="text-muted">Remove a specific assessment file from the server</p>
                
                <div class="mb-3">
                  <label for="quizSelect" class="form-label"><strong>Select Assessment:</strong></label>
                  <select 
                    id="quizSelect" 
                    class="form-select" 
                    [(ngModel)]="selectedAssessmentFileId"
                    [disabled]="assessmentFiles.length === 0">
                    <option value="">-- Choose an assessment --</option>
                    <option *ngFor="let quiz of assessmentFiles" [value]="quiz.id">
                      {{ quiz.title }} (ID: {{ quiz.id }})
                    </option>
                  </select>
                  <small class="text-muted" *ngIf="assessmentFiles.length === 0">No assessment files found</small>
                  <small class="text-muted" *ngIf="assessmentFiles.length > 0">{{ assessmentFiles.length }} assessment file(s) available</small>
                </div>

                <button 
                  class="btn btn-info w-100" 
                  [disabled]="!selectedAssessmentFileId || loading"
                  (click)="deleteAssessmentFile()">
                  <i class="fas fa-trash-alt"></i> Delete Assessment File
                </button>
              </div>
            </div>
          </div>

          <!-- Section 5: Delete all assessment files -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                  <i class="fas fa-folder-minus"></i> Delete All Assessment Files
                </h5>
              </div>
              <div class="card-body">
                <p class="text-muted">Remove all assessment files from the server</p>
                
                <div class="alert alert-danger mb-3">
                  <i class="fas fa-exclamation-triangle"></i>
                  <strong>Warning:</strong> This will delete ALL assessment files. Users will not be able to take any assessments until new ones are uploaded!
                </div>

                <button 
                  class="btn btn-danger w-100" 
                  [disabled]="loading"
                  (click)="deleteAllAssessmentFiles()">
                  <i class="fas fa-fire"></i> Delete All Assessment Files
                </button>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="loading" class="text-center mt-4">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Processing...</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Confirmation Modal -->
<alpha-tronex-modal
  [show]="showConfirmModal"
  [title]="confirmTitle"
  [type]="'danger'"
  [content]="confirmMessage + ' This action cannot be undone.'"
  [scrollToTopOnHide]="true"
  (close)="closeConfirmModal()"
  (confirm)="confirmActionExecute()">
  <div modal-actions>
    <button type="button" class="btn btn-secondary" (click)="closeConfirmModal()">Cancel</button>
    <button type="button" class="btn btn-danger ml-2 mr-2" (click)="confirmActionExecute()">
      <i class="fas fa-trash"></i> Confirm Delete
    </button>
  </div>
</alpha-tronex-modal>
