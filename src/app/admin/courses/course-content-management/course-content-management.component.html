<section class="masthead bg-primary text-white text-center">
  <div class="container">
    <app-admin-breadcrumb></app-admin-breadcrumb>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">Course Content</h2>
      <div class="btn-group" role="group">
        <a class="btn btn-outline-light btn-sm" [routerLink]="['/courses', courseId]">
          <i class="fas fa-external-link-alt"></i> View Course
        </a>
        <button class="btn btn-outline-light btn-sm" (click)="backToCourses()">
          <i class="fas fa-arrow-left"></i> Back to Courses
        </button>
      </div>
    </div>

    <div class="card text-dark mb-4">
      <div class="card-body text-start">
        <div *ngIf="message" class="alert" [ngClass]="messageType === 'success' ? 'alert-success' : 'alert-danger'">
          {{ message }}
        </div>

        <div *ngIf="error" class="alert alert-danger">
          {{ error }}
        </div>

        <div *ngIf="course" class="mb-2">
          <h5 class="mb-1">{{ course.title }}</h5>
          <p class="text-muted mb-0">{{ course.description || '—' }}</p>
          <small class="text-muted">Status: {{ course.status }}</small>

          <div class="mt-3">
            <h6 class="mb-2">Course Assessment</h6>
            <div class="row align-items-end">
              <div class="col-md-7 mb-2 assessment-picker-col">
                <label class="form-label"><strong>Assessment</strong></label>
                <select
                  class="form-select assessment-picker"
                  [(ngModel)]="selectedAssessmentIdByScopeKey['course:' + courseId]"
                  [disabled]="saving || availableAssessmentsLoading || course.status === 'archived'">
                  <option [ngValue]="null">— Select —</option>
                  <option *ngFor="let a of availableAssessments" [ngValue]="a.id">
                    {{ a.id }} — {{ a.title }}
                  </option>
                </select>
              </div>
              <div class="col-md-5 mb-2">
                <div class="btn-group" role="group">
                  <button
                    class="btn btn-primary btn-sm"
                    (click)="attachAssessment('course', courseId)"
                    [disabled]="saving || availableAssessmentsLoading || course.status === 'archived'">
                    Attach/Replace
                  </button>
                  <button
                    class="btn btn-outline-danger btn-sm"
                    (click)="detachAssessment('course', courseId)"
                    [disabled]="saving || !getActiveMapping('course', courseId)">
                    Archive Mapping
                  </button>
                </div>
              </div>
            </div>

            <small class="text-muted" *ngIf="getActiveMapping('course', courseId) as m">
              Attached: {{ m.assessmentId }}<span *ngIf="getAssessmentTitle(m.assessmentId)"> — {{ getAssessmentTitle(m.assessmentId) }}</span>
            </small>
            <small class="text-muted" *ngIf="!getActiveMapping('course', courseId)">Attached: —</small>
          </div>
        </div>

        <div *ngIf="!course" class="alert alert-info mb-0">
          Course not found in admin list (it may be archived or missing). You can still manage lessons.
        </div>
      </div>
    </div>

    <div class="card text-dark mb-4">
      <div class="card-header bg-secondary text-white text-start">
        <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Create Lesson</h5>
      </div>
      <div class="card-body text-start">
        <div class="row">
          <div class="col-md-5 mb-3">
            <label class="form-label"><strong>Title</strong></label>
            <input class="form-control" [(ngModel)]="newLessonTitle" [disabled]="saving" placeholder="Lesson title" />
          </div>
          <div class="col-md-5 mb-3">
            <label class="form-label"><strong>Description</strong></label>
            <input class="form-control" [(ngModel)]="newLessonDescription" [disabled]="saving" placeholder="Optional description" />
          </div>
          <div class="col-md-2 mb-3">
            <label class="form-label"><strong>Sort</strong></label>
            <input class="form-control" type="number" [(ngModel)]="newLessonSortOrder" [disabled]="saving" placeholder="0" />
          </div>
        </div>

        <button class="btn btn-success" (click)="createLesson()" [disabled]="saving">
          <i class="fas fa-save"></i> Create Lesson
        </button>
      </div>
    </div>

    <div class="card text-dark">
      <div class="card-header bg-info text-white text-start">
        <h5 class="mb-0"><i class="fas fa-list"></i> Lessons & Chapters</h5>
      </div>
      <div class="card-body text-start">
        <div *ngIf="loading" class="text-center py-4">
          <p>Loading lessons...</p>
        </div>

        <div *ngIf="!loading && lessons.length === 0" class="alert alert-info">
          No lessons found.
        </div>

        <div *ngIf="!loading && lessons.length > 0">
          <div *ngFor="let lesson of lessons" class="mb-3">
            <div class="card">
              <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge" [ngClass]="lesson.status === 'active' ? 'bg-success' : 'bg-secondary'">
                      {{ lesson.status }}
                    </span>
                    <strong class="ms-2" *ngIf="!isEditingLesson(lesson)">{{ lesson.title }}</strong>
                    <span class="ms-2" *ngIf="isEditingLesson(lesson)">Editing lesson</span>
                  </div>
                  <div class="btn-group" role="group">
                    <button *ngIf="!isEditingLesson(lesson)" class="btn btn-outline-primary btn-sm" (click)="startEditLesson(lesson)" [disabled]="saving">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button *ngIf="isEditingLesson(lesson)" class="btn btn-primary btn-sm" (click)="saveEditLesson(lesson)" [disabled]="saving">
                      <i class="fas fa-save"></i> Save
                    </button>
                    <button *ngIf="isEditingLesson(lesson)" class="btn btn-outline-secondary btn-sm" (click)="cancelEditLesson()" [disabled]="saving">
                      Cancel
                    </button>
                    <button
                      *ngIf="lesson.status !== 'archived'"
                      class="btn btn-outline-danger btn-sm"
                      (click)="archiveLesson(lesson)"
                      [disabled]="saving">
                      <i class="fas fa-archive"></i> Archive
                    </button>
                    <button
                      *ngIf="lesson.status === 'archived'"
                      class="btn btn-outline-success btn-sm"
                      (click)="unarchiveLesson(lesson)"
                      [disabled]="saving">
                      <i class="fas fa-box-open"></i> Unarchive
                    </button>
                  </div>
                </div>
              </div>

              <div class="card-body">
                <div *ngIf="isEditingLesson(lesson)" class="row">
                  <div class="col-md-5 mb-3">
                    <label class="form-label"><strong>Title</strong></label>
                    <input class="form-control" [(ngModel)]="editLessonTitle" [disabled]="saving" />
                  </div>
                  <div class="col-md-5 mb-3">
                    <label class="form-label"><strong>Description</strong></label>
                    <input class="form-control" [(ngModel)]="editLessonDescription" [disabled]="saving" />
                  </div>
                  <div class="col-md-2 mb-3">
                    <label class="form-label"><strong>Sort</strong></label>
                    <input class="form-control" type="number" [(ngModel)]="editLessonSortOrder" [disabled]="saving" />
                  </div>
                </div>

                <div *ngIf="!isEditingLesson(lesson)" class="mb-3">
                  <div class="text-muted">Sort: {{ lesson.sortOrder }}</div>
                  <div class="text-muted">{{ lesson.description || '—' }}</div>
                </div>

                <div class="mb-3">
                  <h6 class="mb-2">Lesson Assessment</h6>
                  <div class="row align-items-end">
                    <div class="col-md-7 mb-2 assessment-picker-col">
                      <select
                        class="form-select form-select-sm assessment-picker"
                        [(ngModel)]="selectedAssessmentIdByScopeKey['lesson:' + lesson.id]"
                        [disabled]="saving || availableAssessmentsLoading || lesson.status === 'archived'">
                        <option [ngValue]="null">— Select —</option>
                        <option *ngFor="let a of availableAssessments" [ngValue]="a.id">
                          {{ a.id }} — {{ a.title }}
                        </option>
                      </select>
                    </div>
                    <div class="col-md-5 mb-2">
                      <div class="btn-group" role="group">
                        <button
                          class="btn btn-primary btn-sm"
                          (click)="attachAssessment('lesson', lesson.id)"
                          [disabled]="saving || availableAssessmentsLoading || lesson.status === 'archived'">
                          Attach/Replace
                        </button>
                        <button
                          class="btn btn-outline-danger btn-sm"
                          (click)="detachAssessment('lesson', lesson.id)"
                          [disabled]="saving || !getActiveMapping('lesson', lesson.id)">
                          Archive
                        </button>
                      </div>
                    </div>
                  </div>

                  <small class="text-muted" *ngIf="getActiveMapping('lesson', lesson.id) as lm">
                    Attached: {{ lm.assessmentId }}<span *ngIf="getAssessmentTitle(lm.assessmentId)"> — {{ getAssessmentTitle(lm.assessmentId) }}</span>
                  </small>
                  <small class="text-muted" *ngIf="!getActiveMapping('lesson', lesson.id)">Attached: —</small>
                </div>

                <hr />

                <h6 class="mb-2">Chapters</h6>

                <div class="row mb-3">
                  <div class="col-md-7 mb-2">
                    <input class="form-control" [(ngModel)]="newChapterTitle[lesson.id]" [disabled]="saving" placeholder="New chapter title" />
                  </div>
                  <div class="col-md-3 mb-2">
                    <input class="form-control" type="number" [(ngModel)]="newChapterSortOrder[lesson.id]" [disabled]="saving" placeholder="Sort" />
                  </div>
                  <div class="col-md-2 mb-2">
                    <button class="btn btn-success w-100" (click)="createChapter(lesson)" [disabled]="saving">
                      <i class="fas fa-plus"></i> Add
                    </button>
                  </div>
                </div>

                <div *ngIf="lesson.chaptersLoading" class="text-center py-2">
                  <p class="mb-0">Loading chapters...</p>
                </div>

                <div *ngIf="!lesson.chaptersLoading && (!lesson.chapters || lesson.chapters.length === 0)" class="alert alert-light mb-0">
                  No chapters.
                </div>

                <div *ngIf="!lesson.chaptersLoading && lesson.chapters && lesson.chapters.length > 0" class="table-responsive">
                  <table class="table table-sm table-striped align-middle">
                    <thead>
                      <tr>
                        <th style="width: 38%">Title</th>
                        <th style="width: 10%">Sort</th>
                        <th style="width: 12%">Status</th>
                        <th style="width: 20%">Assessment</th>
                        <th style="width: 20%">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <ng-container *ngFor="let chapter of lesson.chapters">
                        <tr>
                          <td>
                            <span *ngIf="!isEditingChapter(chapter)"><strong>{{ chapter.title }}</strong></span>
                            <input *ngIf="isEditingChapter(chapter)" class="form-control form-control-sm" [(ngModel)]="editChapterTitle" [disabled]="saving" />
                          </td>
                          <td>
                            <span *ngIf="!isEditingChapter(chapter)">{{ chapter.sortOrder }}</span>
                            <input *ngIf="isEditingChapter(chapter)" class="form-control form-control-sm" type="number" [(ngModel)]="editChapterSortOrder" [disabled]="saving" />
                          </td>
                          <td>
                            <span class="badge" [ngClass]="chapter.status === 'active' ? 'bg-success' : 'bg-secondary'">
                              {{ chapter.status }}
                            </span>
                          </td>
                          <td>
                            <div class="mb-1">
                              <small class="text-muted" *ngIf="getActiveMapping('chapter', chapter.id) as cm">
                                {{ cm.assessmentId }}<span *ngIf="getAssessmentTitle(cm.assessmentId)"> — {{ getAssessmentTitle(cm.assessmentId) }}</span>
                              </small>
                              <small class="text-muted" *ngIf="!getActiveMapping('chapter', chapter.id)">—</small>
                            </div>

                            <div class="d-flex assessment-inline-controls">
                              <select
                                class="form-select form-select-sm me-1 assessment-picker"
                                [(ngModel)]="selectedAssessmentIdByScopeKey['chapter:' + chapter.id]"
                                [disabled]="saving || availableAssessmentsLoading || chapter.status === 'archived'">
                                <option [ngValue]="null">— Select —</option>
                                <option *ngFor="let a of availableAssessments" [ngValue]="a.id">
                                  {{ a.id }} — {{ a.title }}
                                </option>
                              </select>
                              <button
                                class="btn btn-primary btn-sm me-1"
                                (click)="attachAssessment('chapter', chapter.id)"
                                [disabled]="saving || availableAssessmentsLoading || chapter.status === 'archived'">
                                Attach
                              </button>
                              <button
                                class="btn btn-outline-danger btn-sm"
                                (click)="detachAssessment('chapter', chapter.id)"
                                [disabled]="saving || !getActiveMapping('chapter', chapter.id)">
                                Archive
                              </button>
                            </div>
                          </td>
                          <td>
                            <div class="btn-group" role="group">
                              <button class="btn btn-outline-secondary btn-sm" (click)="openContentEditor(chapter)" [disabled]="saving || chapter.status === 'archived'">
                                <i class="fas fa-file-upload"></i> Content
                              </button>
                              <button *ngIf="!isEditingChapter(chapter)" class="btn btn-outline-primary btn-sm" (click)="startEditChapter(chapter)" [disabled]="saving">
                                <i class="fas fa-edit"></i> Edit
                              </button>
                              <button *ngIf="isEditingChapter(chapter)" class="btn btn-primary btn-sm" (click)="saveEditChapter(lesson.id, chapter)" [disabled]="saving">
                                <i class="fas fa-save"></i> Save
                              </button>
                              <button *ngIf="isEditingChapter(chapter)" class="btn btn-outline-secondary btn-sm" (click)="cancelEditChapter()" [disabled]="saving">
                                Cancel
                              </button>
                              <button
                                *ngIf="chapter.status !== 'archived'"
                                class="btn btn-outline-danger btn-sm"
                                (click)="archiveChapter(lesson.id, chapter)"
                                [disabled]="saving">
                                <i class="fas fa-archive"></i> Archive
                              </button>
                              <button
                                *ngIf="chapter.status === 'archived'"
                                class="btn btn-outline-success btn-sm"
                                (click)="unarchiveChapter(lesson.id, chapter)"
                                [disabled]="saving">
                                <i class="fas fa-box-open"></i> Unarchive
                              </button>
                            </div>
                          </td>
                        </tr>
                      </ng-container>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="card text-dark mt-4">
      <div class="card-header bg-dark text-white text-start">
        <h5 class="mb-0"><i class="fas fa-clipboard-list"></i> Assessment Mappings</h5>
      </div>
      <div class="card-body text-start">
        <div *ngIf="mappingsLoading" class="text-center py-2">
          <p class="mb-0">Loading mappings...</p>
        </div>

        <div *ngIf="!mappingsLoading && (!contentAssessmentMappings || contentAssessmentMappings.length === 0)" class="alert alert-light mb-0">
          No mappings.
        </div>

        <div *ngIf="!mappingsLoading && contentAssessmentMappings && contentAssessmentMappings.length > 0" class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th style="width: 12%">Scope</th>
                <th style="width: 38%">Name</th>
                <th style="width: 20%">Assessment</th>
                <th style="width: 15%">Status</th>
                <th style="width: 15%">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let m of contentAssessmentMappings">
                <td>{{ m.scopeType }}</td>
                <td>{{ mappingScopeLabel(m) }}</td>
                <td>
                  {{ m.assessmentId }}
                  <span *ngIf="getAssessmentTitle(m.assessmentId)"> — {{ getAssessmentTitle(m.assessmentId) }}</span>
                </td>
                <td>
                  <span class="badge" [ngClass]="m.status === 'active' ? 'bg-success' : 'bg-secondary'">{{ m.status }}</span>
                </td>
                <td>
                  <button
                    *ngIf="m.status === 'archived'"
                    class="btn btn-outline-success btn-sm"
                    (click)="unarchiveAssessmentMapping(m)"
                    [disabled]="saving || getActiveMapping(m.scopeType, m.scopeId)">
                    Unarchive
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
